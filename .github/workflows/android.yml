name: Build AuryxBrowser APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Create project structure
        run: |
          mkdir -p app/src/main/java/com/xdustatom/auryxbrowser
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          mkdir -p gradle/wrapper

      - name: settings.gradle
        run: |
          cat <<EOF > settings.gradle
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "AuryxBrowser"
          include(":app")
          EOF

      - name: Root build.gradle
        run: |
          cat <<EOF > build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath "com.android.tools.build:gradle:8.2.2"
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.22"
              }
          }
          EOF

      - name: App build.gradle
        run: |
          cat <<EOF > app/build.gradle
          apply plugin: "com.android.application"
          apply plugin: "org.jetbrains.kotlin.android"

          android {
              namespace "com.xdustatom.auryxbrowser"
              compileSdk 34

              defaultConfig {
                  applicationId "com.xdustatom.auryxbrowser"
                  minSdk 21
                  targetSdk 34
                  versionCode 120801
                  versionName "1.208.01"
              }

              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
          }

          dependencies {
              implementation "org.jetbrains.kotlin:kotlin-stdlib:1.9.22"
              implementation "androidx.webkit:webkit:1.9.0"
          }
          EOF

      - name: AndroidManifest.xml
        run: |
          cat <<EOF > app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.xdustatom.auryxbrowser">

              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>

              <uses-feature
                  android:name="android.software.leanback"
                  android:required="true"/>

              <application
                  android:label="AuryxBrowser"
                  android:theme="@android:style/Theme.Black.NoTitleBar.Fullscreen">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LEANBACK_LAUNCHER"/>
                      </intent-filter>
                  </activity>

              </application>
          </manifest>
          EOF

      - name: Layout
        run: |
          cat <<EOF > app/src/main/res/layout/activity_main.xml
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:orientation="vertical"
              android:layout_width="match_parent"
              android:layout_height="match_parent">

              <EditText
                  android:id="@+id/urlBar"
                  android:layout_width="match_parent"
                  android:layout_height="48dp"
                  android:hint="https://"/>

              <WebView
                  android:id="@+id/webView"
                  android:layout_width="match_parent"
                  android:layout_height="match_parent"/>
          </LinearLayout>
          EOF

      - name: MainActivity
        run: |
          cat <<EOF > app/src/main/java/com/xdustatom/auryxbrowser/MainActivity.kt
          package com.xdustatom.auryxbrowser

          import android.app.Activity
          import android.os.Bundle
          import android.webkit.WebView
          import android.webkit.WebViewClient
          import android.widget.EditText
          import android.view.inputmethod.EditorInfo

          class MainActivity : Activity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)

                  val webView = findViewById<WebView>(R.id.webView)
                  val urlBar = findViewById<EditText>(R.id.urlBar)

                  webView.settings.javaScriptEnabled = true
                  webView.webViewClient = WebViewClient()
                  webView.loadUrl("https://www.google.com")

                  urlBar.setOnEditorActionListener { _, actionId, _ ->
                      if (actionId == EditorInfo.IME_ACTION_GO) {
                          webView.loadUrl(urlBar.text.toString())
                          true
                      } else false
                  }
              }
          }
          EOF

      - name: Gradle wrapper
        run: |
          curl -L https://services.gradle.org/distributions/gradle-8.4-bin.zip -o gradle.zip
          unzip gradle.zip
          mv gradle-8.4 gradle-dist
          echo '#!/bin/bash' > gradlew
          echo './gradle-dist/bin/gradle "$@"' >> gradlew
          chmod +x gradlew

      - name: Build APK
        run: |
          ./gradlew assembleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AuryxBrowser-APK
          path: app/build/outputs/apk/release/*.apk
